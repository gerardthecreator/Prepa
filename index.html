<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estructuras de Lewis Interactivas</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
        });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Estilos CSS - Comienzo */
        :root {
            /* Colores Base - Optimizados para contraste en TEMA CLARO */
            --primary-color: #3498db; /* Azul vibrante para elementos clave */
            --secondary-color: #2c3e50; /* Azul oscuro para encabezados/texto principal */
            --accent-color: #e74c3c; /* Rojo para electrones/énfasis */
            --bg-color: #f4f7f6; /* Fondo claro general */
            --card-bg: #ffffff; /* Fondo de tarjetas y contenedores blancos */
            --text-color: #333; /* Texto oscuro principal */
            --border-color: #e0e0e0; /* Borde claro */
            --shadow-light: rgba(0,0,0,0.08); /* Sombra sutil */
            --shadow-medium: rgba(0,0,0,0.15); /* Sombra más pronunciada */
            --anton-font: 'Anton', sans-serif;
            --transition-speed: 0.3s;
        }

        /* Variables para el Modo Oscuro - Se aplican solo si la clase dark-mode está activa */
        body.dark-mode {
            --primary-color: #6da7e6; /* Azul claro para modo oscuro, mantiene energía */
            --secondary-color: #8bbcdc; /* Azul grisáceo claro para encabezados */
            --accent-color: #ff8a80; /* Rojo más brillante, legible */
            --bg-color: #1a202c; /* Fondo muy oscuro, reduce fatiga visual */
            --card-bg: #2d3748; /* Fondo de tarjeta oscuro, distinto del fondo */
            --text-color: #e2e8f0; /* Texto muy claro */
            --border-color: #4a5568; /* Borde oscuro */
            --shadow-light: rgba(0,0,0,0.4);
            --shadow-medium: rgba(0,0,0,0.6);
        }

        /* Reseteo básico y configuración global */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color); /* Usa el color de fondo definido */
            color: var(--text-color); /* Usa el color de texto definido */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; /* Transición suave al cambiar de tema */
        }

        /* Fuente Anton para títulos y elementos clave */
        .anton-font {
            font-family: var(--anton-font);
        }

        /* Estilos del encabezado */
        header {
            background-color: var(--secondary-color); /* Color de fondo del encabezado */
            color: #fff; /* Texto blanco en el encabezado para alto contraste */
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px var(--shadow-medium);
            flex-shrink: 0; /* Previene que el header se encoja en pantallas pequeñas */
        }

        h1 {
            margin: 0;
            font-family: var(--anton-font);
            font-size: clamp(1.8rem, 5vw, 2.5rem); /* Tamaño de fuente responsivo */
            color: inherit; /* Hereda el color blanco del header */
        }

        /* Contenedor principal de la aplicación */
        main {
            flex-grow: 1; /* Ocupa el espacio disponible */
            padding: 1rem 0.5rem; /* Menor padding horizontal para móviles */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea el contenido arriba */
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
            overflow-y: auto; /* Permite scroll vertical si el contenido excede la altura */
        }

        #app {
            background-color: var(--card-bg); /* Fondo de la tarjeta principal */
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--shadow-light);
            padding: 1rem; /* Padding adaptado para móviles */
            width: 95%; /* Ocupa casi todo el ancho en móviles */
            max-width: 900px; /* Ancho máximo para pantallas más grandes */
            margin-top: 10px; /* Margen superior */
            position: relative;
            overflow: hidden; /* Asegura que no haya desbordamiento de contenido */
        }

        /* Selector de moléculas (dropdown) */
        .molecule-selector {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Espacio entre label y select */
        }

        .molecule-selector label {
            font-weight: bold;
            color: var(--primary-color); /* Color vibrante para el label */
            font-size: 0.95rem; /* Tamaño de fuente para móviles */
        }

        .molecule-selector select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9rem; /* Tamaño de fuente */
            appearance: none; /* Oculta la flecha nativa del select */
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 0.65em auto;
            cursor: pointer;
            /* SVG para la flecha del dropdown en modo claro */
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        }
        /* SVG para la flecha del dropdown en modo oscuro */
        body.dark-mode .molecule-selector select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e2e8f0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        }

        /* Títulos de las moléculas */
        h2 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 1rem;
            font-family: var(--anton-font);
            font-size: clamp(1.4rem, 4vw, 2rem); /* Tamaño de fuente responsivo */
        }
        h2 span {
            font-size: 0.8em; /* Fórmula un poco más pequeña que el nombre */
            vertical-align: super; /* Ajuste para subíndices/superíndices */
            line-height: 0;
        }

        /* Navegación de pasos (anterior/siguiente) */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color); /* Separador visual */
            flex-wrap: wrap; /* Permite que los botones se envuelvan */
            gap: 0.5rem; /* Espacio entre elementos */
        }

        .step-navigation button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed) ease, transform 0.1s ease;
            flex: 1; /* Permite que los botones ocupen el espacio disponible */
            min-width: 100px; /* Ancho mínimo para cada botón */
        }

        .step-navigation button:hover {
            filter: brightness(1.2); /* Efecto de brillo al pasar el ratón */
            transform: translateY(-2px); /* Pequeño desplazamiento hacia arriba */
        }

        .step-navigation button:disabled {
            background-color: var(--border-color); /* Color para botones deshabilitados */
            color: var(--text-color);
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        .step-navigation span {
            font-size: 1rem;
            font-weight: bold;
            color: var(--text-color);
            flex-grow: 1; /* Ocupa el espacio central */
            text-align: center;
        }

        /* Área de explicación del paso actual */
        .explanation {
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); /* Fondo semitransparente con color primario */
            border-left: 5px solid var(--primary-color); /* Borde izquierdo distintivo */
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Contenedor de la estructura de Lewis (SVG) */
        .lewis-structure-container {
            background-color: var(--bg-color); /* Fondo del lienzo de la estructura */
            border: 1px dashed var(--border-color); /* Borde punteado para indicar el área */
            border-radius: 8px;
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            overflow: hidden;
            min-height: 100px; /* Altura mínima para la estructura */
            max-height: 250px; /* Altura máxima para evitar que sea muy grande en desktop */
            position: relative;
            width: 100%;
        }

        /* Estilos del SVG interno - IMPORTANTE para el escalado */
        .lewis-structure-container svg {
            display: block;
            width: 100%; /* El SVG toma el 100% del ancho de su contenedor */
            height: auto; /* Mantiene la proporción automáticamente */
            /* El viewBox (en el HTML) define las coordenadas internas, permitiendo "zoom" */
        }

        /* Estilos de los elementos dentro del SVG */
        .atom-circle {
            stroke: var(--secondary-color); /* Borde del átomo */
            stroke-width: 0.5px; /* Grosor de borde proporcional al viewBox */
            transition: fill 0.2s ease, stroke 0.2s ease;
        }
        .atom-text {
            font-family: var(--anton-font);
            font-size: 5px; /* Tamaño de fuente proporcionalmente pequeño */
            fill: var(--text-color); /* Color del símbolo del átomo */
            user-select: none; /* Previene selección de texto */
        }
        .electron-dot {
            fill: var(--accent-color); /* Color de los electrones (rojo) */
            cursor: grab; /* Cursor para indicar que es arrastrable */
            r: 1px; /* Radio del electrón (muy pequeño) */
        }
        .bond-line {
            stroke: var(--secondary-color); /* Color de los enlaces */
            stroke-width: 1.5px; /* Grosor de los enlaces */
            stroke-linecap: round; /* Extremos redondeados para los enlaces */
        }
        .formal-charge-text {
            font-size: 3px; /* Tamaño de fuente para las cargas formales */
            fill: var(--accent-color); /* Color de las cargas formales (rojo) */
            font-weight: bold;
        }
        /* Resaltado de átomos y enlaces */
        .highlighted-atom .atom-circle {
            stroke: var(--primary-color);
            stroke-width: 1px;
            fill: color-mix(in srgb, var(--primary-color) 20%, transparent);
        }
        .highlighted-bond .bond-line {
            stroke: var(--primary-color);
            stroke-width: 2px;
        }
        /* Cursor durante el arrastre de electrones */
        .drag-active {
            cursor: grabbing !important;
            opacity: 0.7;
        }

        /* Notación MathJax */
        .math-notation {
            text-align: center;
            font-size: 1rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        /* Acciones adicionales (botones) */
        .extra-actions {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .extra-actions button {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease, transform 0.1s ease;
            font-size: 0.9rem;
        }
        .extra-actions button:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }

        /* Pie de página */
        footer {
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            color: #777;
            font-size: 0.8rem;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 5px var(--shadow-light);
            flex-shrink: 0; /* Previene que el footer se encoja */
        }

        /* Overlay de carga (cuando la aplicación está cargando algo) */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Fondo semi-transparente claro */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--secondary-color);
            z-index: 1000;
            pointer-events: none; /* No interactuable por defecto */
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        body.dark-mode .loading-overlay { /* Estilos para el overlay en modo oscuro */
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-color);
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: auto; /* Se vuelve interactuable cuando está activo */
        }
        .loading-spinner { /* Animación de carga */
            border: 3px solid var(--primary-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notificaciones tipo "Toast" */
        .toast-container {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10000;
            pointer-events: none;
            max-width: 90%;
        }
        .toast {
            background-color: rgba(52, 152, 219, 0.9); /* Azul para info */
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: auto;
            font-size: 0.85rem;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: rgba(46, 204, 113, 0.9); } /* Verde para éxito */
        .toast.error { background-color: rgba(231, 76, 60, 0.9); } /* Rojo para error */
        .toast.info { background-color: rgba(52, 152, 219, 0.9); } /* Azul para información */

        /* Botón de alternar tema (modo claro/oscuro) */
        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-light);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
            z-index: 9999;
        }
        .theme-toggle svg {
            fill: var(--text-color); /* El icono se adapta al color del texto */
            transition: fill var(--transition-speed);
            width: 20px;
            height: 20px;
        }

        /* Modal de Tutorial/Ayuda */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Fondo semi-transparente oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden; /* Oculto por defecto */
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible; /* Visible cuando está activo */
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-medium);
            max-width: 90%;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto; /* Permite scroll si el contenido es largo */
            position: relative;
            transform: translateY(-30px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .modal-content h3 {
            font-size: 1.2rem;
            margin-top: 0;
            margin-bottom: 0.8rem;
        }
        .modal-content ul {
            padding-left: 1.2rem;
            margin-bottom: 0.8rem;
        }
        .modal-content li {
            margin-bottom: 0.4rem;
        }
        .modal-close-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--text-color);
            line-height: 1;
        }

        /* Media Queries para responsividad (escalado para pantallas más grandes) */
        @media (min-width: 600px) {
            #app {
                padding: 1.5rem;
                margin-top: 20px;
            }
            .step-navigation button {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
            }
            .extra-actions button {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
            }
            .step-navigation span {
                font-size: 1.2rem;
            }
            .explanation {
                padding: 1rem;
                font-size: 1.1rem;
            }
            .math-notation {
                padding: 0.75rem;
                font-size: 1.2rem;
            }
            .lewis-structure-container {
                padding: 1rem;
                min-height: 250px;
                max-height: none; /* Eliminar restricción de altura en desktop */
            }
            .theme-toggle {
                width: 40px;
                height: 40px;
                top: 20px;
                right: 20px;
            }
            .theme-toggle svg {
                width: 24px;
                height: 24px;
            }
            .modal-content {
                padding: 2rem;
                max-width: 600px;
                font-size: 1rem;
            }
            .modal-content h3 {
                font-size: 1.5rem;
            }
        }
        /* Estilos CSS - Fin */
    </style>
</head>
<body>
    <header>
        <h1>Estructuras de Lewis Interactivas</h1>
    </header>

    <main id="app-container">
        <div id="app">
            <div class="loading-overlay" :class="{ 'active': isLoading }" aria-live="polite" aria-label="Cargando contenido">
                <div class="loading-spinner"></div>
                <p>Cargando estructura...</p>
            </div>

            <section class="molecule-selector">
                <label for="molecules">Selecciona una molécula:</label>
                <select id="molecules" v-model="selectedMoleculeId" @change="loadMolecule" aria-controls="lewis-structure-area">
                    <option v-for="mol in moleculesList" :value="mol.id" :key="mol.id">{{ mol.name }}</option>
                </select>
            </section>

            <template v-if="currentMolecule">
                <h2 class="anton-font">{{ currentMolecule.name }} <span v-html="currentMolecule.formulaHtml"></span></h2>

                <div class="step-navigation" role="navigation" aria-label="Navegación de pasos de la estructura de Lewis">
                    <button @click="prevStep" :disabled="currentStepIndex === 0" aria-label="Paso anterior">Anterior</button>
                    <span class="anton-font" aria-live="polite">Paso {{ currentStepIndex + 1 }} de {{ currentMolecule.steps.length }}</span>
                    <button @click="nextStep" :disabled="currentStepIndex === currentMolecule.steps.length - 1" aria-label="Paso siguiente">Siguiente</button>
                </div>

                <div class="explanation" v-html="currentStep.explanation" aria-live="polite"></div>

                <div class="lewis-structure-container" id="lewis-structure-area">
                    <svg :width="svgWidth" :height="svgHeight" viewBox="0 0 100 50"
                         aria-label="Diagrama de la estructura de Lewis actual">
                        <line v-for="bond in currentStep.bonds" :key="'bond-' + bond.id"
                              :x1="bond.x1" :y1="bond.y1" :x2="bond.x2" :y2="bond.y2"
                              :stroke="bond.color || 'var(--secondary-color)'" :stroke-width="bond.width || 1.5"
                              class="bond-line"
                              :class="{'highlighted-bond': bond.highlighted}"></line>

                        <g v-for="atom in currentStep.atoms" :key="'atom-' + atom.id"
                           :transform="`translate(${atom.x}, ${atom.y})`"
                           class="atom-group"
                           :class="{'highlighted-atom': atom.highlighted}">
                            <circle :r="atom.radius" :fill="atom.color || 'transparent'" class="atom-circle"></circle>
                            <text x="0" y="0" text-anchor="middle" dominant-baseline="middle" class="atom-text">{{ atom.symbol }}</text>
                            <text v-if="atom.formal_charge !== undefined && atom.formal_charge !== '' && atom.formal_charge !== '0'"
                                  :x="atom.radius * 0.7 + 0.5" :y="-atom.radius * 0.7 + 0.5" class="formal-charge-text">
                                {{ atom.formal_charge > 0 ? '+' : '' }}{{ atom.formal_charge }}
                            </text>
                            <circle v-for="(electron, index) in interactiveElectrons[atom.id]"
                                    :key="atom.id + '-e-' + index"
                                    :cx="electron.x"
                                    :cy="electron.y"
                                    r="1" class="electron-dot"
                                    @mousedown="startDragElectron(atom.id, index, $event)"
                                    @touchstart="startDragElectron(atom.id, index, $event)">
                            </circle>
                        </g>
                    </svg>
                </div>
                <div class="math-notation" v-html="renderedMathJax"></div>

                <div class="extra-actions">
                    <button @click="downloadScreenshot" aria-label="Descargar estructura actual">Descargar Estructura</button>
                    <button @click="resetCurrentMolecule" aria-label="Reiniciar estructura actual">Reiniciar Estructura</button>
                    <button @click="openTutorialModal" aria-label="Mostrar ayuda y tutorial de uso">Ayuda / Tutorial</button>
                </div>
            </template>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Estructuras de Lewis Interactivas</p>
    </footer>

    <div class="theme-toggle" @click="toggleDarkMode" tabindex="0" role="button" :aria-label="`Activar modo ${isDarkMode ? 'claro' : 'oscuro'}`">
        <svg v-if="isDarkMode" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.34 2.42-3.91 2.97-2.29.75-4.78-.29-6.07-2.58C7.15 10.42 7.7 7.57 9.8 6.07c.68-.43 1.34-.84 2-1.21V3zm0 15c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.36 0 2.6-.47 3.67-1.28-.2.99-.47 1.97-.89 2.9-.84 1.83-2.6 3.16-4.69 3.45-1.07.15-2.14.0-3.15-.36-1.08-.39-2.02-.99-2.82-1.74-1.23-1.16-1.92-2.73-1.92-4.42 0-3.31 2.69-6 6-6s6 2.69 6 6c0 .48-.06.94-.17 1.38-.98 1.37-2.34 2.42-3.91 2.97-2.29.75-4.78-.29-6.07-2.58C7.15 10.42 7.7 7.57 9.8 6.07c.68-.43 1.34-.84 2-1.21V3zm0 15c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.36 0 2.6-.47 3.67-1.28-.2.99-.47 1.97-.89 2.9-.84 1.83-2.6 3.16-4.69 3.45-1.07.15-2.14.0-3.15-.36-1.08-.39-2.02-.99-2.82-1.74-1.23-1.16-1.92-2.73-1.92-4.42 0-3.31 2.69-6 6-6s6 2.69 6 6z"/></svg>
        <svg v-else xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 2c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7zM11 5h2v6h-2zM11 13h2v2h-2z"/></svg>
    </div>

    <div class="toast-container"></div>

    <div class="modal-overlay" :class="{'show': showTutorialModal}" @click.self="showTutorialModal = false" role="dialog" aria-modal="true" aria-labelledby="tutorial-title">
        <div class="modal-content">
            <button class="modal-close-button" @click="showTutorialModal = false" aria-label="Cerrar tutorial">&times;</button>
            <h3 id="tutorial-title" class="anton-font">¿Cómo usar esta aplicación?</h3>
            <p>¡Bienvenido! Esta herramienta interactiva te guiará paso a paso para construir estructuras de Lewis.</p>
            <ul>
                <li><strong>Selección de Molécula:</strong> Usa el menú desplegable "Selecciona una molécula" para elegir el compuesto que quieres analizar.</li>
                <li><strong>Navegación por Pasos:</strong> Usa los botones "Anterior" y "Siguiente" para avanzar o retroceder en el proceso de construcción de la estructura. Cada paso te proporcionará una explicación detallada.</li>
                <li><strong>Interactividad con Electrones:</strong> En algunos pasos, podrás arrastrar y soltar los puntos que representan electrones para formar pares libres o enlaces. Intenta moverlos y observa el resultado.</li>
                <li><strong>Cálculos y Cargas Formales:</strong> La aplicación te mostrará los electrones de valencia y las cargas formales para ayudarte a entender la estabilidad de la estructura.</li>
                <li><strong>Modo Oscuro:</strong> Haz clic en el icono de Sol/Luna en la esquina superior derecha para cambiar entre el modo claro y oscuro.</li>
                <li><strong>Descargar Estructura:</strong> El botón "Descargar Estructura" te permitirá guardar la imagen de la estructura actual.</li>
                <li><strong>Reiniciar Estructura:</strong> Si quieres empezar de nuevo con la molécula actual, usa el botón "Reiniciar Estructura".</li>
            </ul>
            <p>¡Esperamos que disfrutes aprendiendo sobre las Estructuras de Lewis de una manera interactiva!</p>
        </div>
    </div>

    <script>
        // Lógica JavaScript - Comienzo

        // --- FUNCIONES DE UTILIDAD ---
        // Muestra una notificación temporal (toast) en la parte inferior de la pantalla.
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.querySelector('.toast-container') || (() => {
                // Si el contenedor no existe, lo crea y lo añade al body
                const div = document.createElement('div');
                div.className = 'toast-container';
                document.body.appendChild(div);
                return div;
            })();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`; // Añade clase de tipo (info, success, error)
            toast.innerHTML = message;
            container.appendChild(toast);

            // Fuerza un reflow para asegurar que la transición de opacidad y transformación se aplique correctamente
            void toast.offsetWidth;

            toast.classList.add('show'); // Activa la visibilidad del toast

            // Temporizador para ocultar y remover el toast
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove()); // Remueve el toast del DOM después de la transición
            }, duration);
        }

        // --- UTILIDADES MATEMÁTICAS (para posicionamiento de electrones) ---
        // Calcula las posiciones de los electrones alrededor de un átomo.
        function getElectronPositions(count, electronRadius, atomRadius) {
            const positions = [];
            // baseOffset es la distancia desde el centro del átomo hasta el centro del electrón.
            // Ajustado para la escala pequeña del SVG (viewBox="0 0 100 50").
            const baseOffset = atomRadius + electronRadius + 0.5;

            for (let i = 0; i < count; i++) {
                // Distribuye los electrones uniformemente en un círculo alrededor del átomo.
                // Math.PI / 8 añade un pequeño desplazamiento inicial para evitar que los electrones se superpongan directamente con los ejes.
                const angle = (i * (2 * Math.PI / count)) + (Math.PI / 8);
                positions.push({
                    x: baseOffset * Math.cos(angle),
                    y: baseOffset * Math.sin(angle)
                });
            }
            return positions;
        }

        // --- DATOS (Definiciones de Moléculas - Coordenadas y Pasos) ---
        // Cada molécula tiene su id, nombre, fórmula (para MathJax y HTML), y una serie de pasos.
        // Cada paso contiene la explicación, la fórmula MathJax, la lista de átomos (con sus propiedades y coordenadas),
        // los enlaces y el número de electrones de valencia no enlazantes por átomo en ese paso.
        const moleculesData = [
            {
                id: 'h2nnh2',
                name: 'Hidrazina',
                formula: 'H$_2$NNH$_2$', // Fórmula para MathJax
                formulaHtml: 'H₂NNH₂', // Fórmula para HTML simple
                steps: [
                    {
                        explanation: "Paso 1: Calcular los electrones de valencia totales. <ul><li>Hidrógeno (H): 1 valencia x 4 átomos = 4</li><li>Nitrógeno (N): 5 valencia x 2 átomos = 10</li><li>Total: 4 + 10 = <strong>14 electrones de valencia</strong>.</li></ul>",
                        mathJax: "H_2NNH_2",
                        atoms: [
                            // Coordenadas ajustadas para viewBox="0 0 100 50"
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'N1', symbol: 'N', x: 30, y: 25, radius: 4, color: '#ffcc80', formal_charge: '' },
                            { id: 'N2', symbol: 'N', x: 40, y: 25, radius: 4, color: '#ffcc80', formal_charge: '' },
                            { id: 'H2', symbol: 'H', x: 50, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'H3', symbol: 'H', x: 30, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'H4', symbol: 'H', x: 40, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '' },
                        ],
                        bonds: [],
                        valence_electrons_per_atom: {
                            'H1': 0, 'N1': 0, 'N2': 0, 'H2': 0, 'H3': 0, 'H4': 0
                        }
                    },
                    {
                        explanation: "Paso 2: Dibujar el esqueleto de la molécula. Los átomos de N son el centro y los hidrógenos se unen a ellos. Se utilizan 10 electrones en los 5 enlaces simples.",
                        mathJax: "H_2N-NH_2",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'N1', symbol: 'N', x: 30, y: 25, radius: 4, color: '#ffcc80', formal_charge: '' },
                            { id: 'N2', symbol: 'N', x: 40, y: 25, radius: 4, color: '#ffcc80', formal_charge: '' },
                            { id: 'H2', symbol: 'H', x: 50, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'H3', symbol: 'H', x: 30, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'H4', symbol: 'H', x: 40, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '' },
                        ],
                        bonds: [
                            { id: 'bH1N1', x1: 20, y1: 25, x2: 30, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bN1N2', x1: 30, y1: 25, x2: 40, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bN2H2', x1: 40, y1: 25, x2: 50, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bN1H3', x1: 30, y1: 25, x2: 30, y2: 15, width: 1.5, highlighted: true },
                            { id: 'bN2H4', x1: 40, y1: 25, x2: 40, y2: 15, width: 1.5, highlighted: true },
                        ],
                        valence_electrons_per_atom: {
                            'H1': 0, 'N1': 0, 'N2': 0, 'H2': 0, 'H3': 0, 'H4': 0
                        }
                    },
                    {
                        explanation: "Paso 3: Distribuir los 4 electrones de valencia restantes (14 totales - 10 usados en enlaces). Cada átomo de nitrógeno necesita un par libre para completar su octeto.",
                        mathJax: "H_2N-NH_2",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'N1', symbol: 'N', x: 30, y: 25, radius: 4, color: '#ffcc80', formal_charge: '0' },
                            { id: 'N2', symbol: 'N', x: 40, y: 25, radius: 4, color: '#ffcc80', formal_charge: '0' },
                            { id: 'H2', symbol: 'H', x: 50, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'H3', symbol: 'H', x: 30, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'H4', symbol: 'H', x: 40, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                        ],
                        bonds: [
                            { id: 'bH1N1', x1: 20, y1: 25, x2: 30, y2: 25, width: 1.5 },
                            { id: 'bN1N2', x1: 30, y1: 25, x2: 40, y2: 25, width: 1.5 },
                            { id: 'bN2H2', x1: 40, y1: 25, x2: 50, y2: 25, width: 1.5 },
                            { id: 'bN1H3', x1: 30, y1: 25, x2: 30, y2: 15, width: 1.5 },
                            { id: 'bN2H4', x1: 40, y1: 25, x2: 40, y2: 15, width: 1.5 },
                        ],
                        // 2 electrones (1 par) en cada N
                        valence_electrons_per_atom: {
                            'H1': 0, 'N1': 2, 'N2': 2, 'H2': 0, 'H3': 0, 'H4': 0
                        }
                    },
                    {
                        explanation: "Paso 4: Verificar octetos y calcular cargas formales. Todos los átomos tienen octeto (o dúo para H).<br>Carga formal = (Valencia) - (e- no enlazantes) - (1/2 * e- enlazantes).<br>Para N: 5 - 2 - (1/2 * 6) = 5 - 2 - 3 = 0.<br>Para H: 1 - 0 - (1/2 * 2) = 1 - 0 - 1 = 0.  Todos son 0. ¡Estructura final!",
                        mathJax: "H_2NNH_2",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'N1', symbol: 'N', x: 30, y: 25, radius: 4, color: '#ffcc80', formal_charge: '0' },
                            { id: 'N2', symbol: 'N', x: 40, y: 25, radius: 4, color: '#ffcc80', formal_charge: '0' },
                            { id: 'H2', symbol: 'H', x: 50, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'H3', symbol: 'H', x: 30, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'H4', symbol: 'H', x: 40, y: 15, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                        ],
                        bonds: [
                            { id: 'bH1N1', x1: 20, y1: 25, x2: 30, y2: 25, width: 1.5 },
                            { id: 'bN1N2', x1: 30, y1: 25, x2: 40, y2: 25, width: 1.5 },
                            { id: 'bN2H2', x1: 40, y1: 25, x2: 50, y2: 25, width: 1.5 },
                            { id: 'bN1H3', x1: 30, y1: 25, x2: 30, y2: 15, width: 1.5 },
                            { id: 'bN2H4', x1: 40, y1: 25, x2: 40, y2: 15, width: 1.5 },
                        ],
                        valence_electrons_per_atom: {
                            'H1': 0, 'N1': 2, 'N2': 2, 'H2': 0, 'H3': 0, 'H4': 0
                        }
                    }
                ]
            },
            {
                id: 'hooh',
                name: 'Peróxido de Hidrógeno',
                formula: 'HOOH',
                formulaHtml: 'HOOH',
                steps: [
                    {
                        explanation: "Paso 1: Calcular electrones de valencia. H: 1 x 2 = 2. O: 6 x 2 = 12. Total: 2+12 = <strong>14 electrones de valencia</strong>.",
                        mathJax: "HOOH",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 35, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O2', symbol: 'O', x: 65, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'H2', symbol: 'H', x: 80, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                        ],
                        bonds: [],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 0, 'O2': 0, 'H2': 0 }
                    },
                    {
                        explanation: "Paso 2: Dibujar el esqueleto. H-O-O-H. Un oxígeno se une al otro, y cada uno se une a un hidrógeno. Se utilizan 6 electrones en los 3 enlaces simples.",
                        mathJax: "H-O-O-H",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 35, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O2', symbol: 'O', x: 65, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'H2', symbol: 'H', x: 80, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                        ],
                        bonds: [
                            { id: 'bH1O1', x1: 20, y1: 25, x2: 35, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bO1O2', x1: 35, y1: 25, x2: 65, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bO2H2', x1: 65, y1: 25, x2: 80, y2: 25, width: 1.5, highlighted: true },
                        ],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 0, 'O2': 0, 'H2': 0 }
                    },
                    {
                        explanation: "Paso 3: Distribuir los 8 electrones restantes (14 totales - 6 usados en enlaces). Cada oxígeno necesita 4 electrones (2 pares libres) para completar su octeto. Arrastra los puntos rojos para formar los pares.",
                        mathJax: "H-O-O-H",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'O1', symbol: 'O', x: 35, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                            { id: 'O2', symbol: 'O', x: 65, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                            { id: 'H2', symbol: 'H', x: 80, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                        ],
                        bonds: [
                            { id: 'bH1O1', x1: 20, y1: 25, x2: 35, y2: 25, width: 1.5 },
                            { id: 'bO1O2', x1: 35, y1: 25, x2: 65, y2: 25, width: 1.5 },
                            { id: 'bO2H2', x1: 65, y1: 25, x2: 80, y2: 25, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 4, 'O2': 4, 'H2': 0 } // Each O gets 2 lone pairs (4 electrons)
                    },
                     {
                        explanation: "Paso 4: Verificar octetos y calcular cargas formales. Todos los átomos cumplen octeto/dúo.<br>Para H: 1 - 0 - (1/2 * 2) = 0.<br>Para O: 6 - 4 - (1/2 * 4) = 0. ¡Estructura final con cargas formales de 0!",
                        mathJax: "H-O-O-H",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 20, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'O1', symbol: 'O', x: 35, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                            { id: 'O2', symbol: 'O', x: 65, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                            { id: 'H2', symbol: 'H', x: 80, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                        ],
                        bonds: [
                            { id: 'bH1O1', x1: 20, y1: 25, x2: 35, y2: 25, width: 1.5 },
                            { id: 'bO1O2', x1: 35, y1: 25, x2: 65, y2: 25, width: 1.5 },
                            { id: 'bO2H2', x1: 65, y1: 25, x2: 80, y2: 25, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 4, 'O2': 4, 'H2': 0 }
                    }
                ]
            },
            {
                id: 'so4_2-',
                name: 'Ion Sulfato',
                formula: 'SO$_4^{2-}$',
                formulaHtml: 'SO₄²⁻',
                steps: [
                    {
                        explanation: "Paso 1: Calcular electrones de valencia. S: 6, O: 6x4=24. Carga iónica: 2-. Total: 6+24+2 = <strong>32 electrones de valencia</strong>.",
                        mathJax: "SO_4^{2-}",
                        atoms: [
                            // Ajuste para mejor visualización en un viewBox de 100x50
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '' }, // Central S
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Top
                            { id: 'O2', symbol: 'O', x: 50, y: 40, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Bottom
                            { id: 'O3', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Left
                            { id: 'O4', symbol: 'O', x: 70, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Right
                        ],
                        bonds: [],
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 0, 'O2': 0, 'O3': 0, 'O4': 0 }
                    },
                    {
                        explanation: "Paso 2: Dibujar el esqueleto. Azufre central, oxígenos alrededor. Se utilizan 8 electrones en los 4 enlaces simples. (32 - 8 = 24 electrones restantes).",
                        mathJax: "S-(O)_4",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O2', symbol: 'O', x: 50, y: 40, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O3', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O4', symbol: 'O', x: 70, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5, highlighted: true },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 50, y2: 40, width: 1.5, highlighted: true },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 30, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bS1O4', x1: 50, y1: 25, x2: 70, y2: 25, width: 1.5, highlighted: true },
                        ],
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 0, 'O2': 0, 'O3': 0, 'O4': 0 }
                    },
                    {
                        explanation: "Paso 3: Distribuir los 24 electrones restantes. Cada oxígeno recibe 6 electrones (3 pares libres) para completar su octeto. El azufre central tiene 8 electrones por ahora.",
                        mathJax: "SO_4^{2-}",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '2+' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O2', symbol: 'O', x: 50, y: 40, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O3', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O4', symbol: 'O', x: 70, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5 },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 50, y2: 40, width: 1.5 },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 30, y2: 25, width: 1.5 },
                            { id: 'bS1O4', x1: 50, y1: 25, x2: 70, y2: 25, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 6, 'O2': 6, 'O3': 6, 'O4': 6 } // Each O gets 3 lone pairs (6 electrons)
                    },
                     {
                        explanation: "Paso 4: Resonancia y Cargas Formales. Múltiples estructuras son posibles (resonancia). La forma más estable minimiza las cargas formales al expandir el octeto del Azufre. Aquí se muestra una donde el S tiene dos dobles enlaces y dos simples. Arrastra los pares de electrones de un Oxígeno a un enlace para formar un doble enlace.",
                        mathJax: "SO_4^{2-}",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '0' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O2', symbol: 'O', x: 50, y: 40, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O3', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' }, // Ahora doble enlazado
                            { id: 'O4', symbol: 'O', x: 70, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' }, // Ahora doble enlazado
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5 },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 50, y2: 40, width: 1.5 },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 30, y2: 25, width: 3, isDouble: true }, // Doble enlace
                            { id: 'bS1O4', x1: 50, y1: 25, x2: 70, y2: 25, width: 3, isDouble: true }, // Doble enlace
                        ],
                        // O3 y O4 ahora tienen 2 pares libres (4 electrones)
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 6, 'O2': 6, 'O3': 4, 'O4': 4 },
                        animation: {
                            type: 'resonance', // Custom animation type for visualization
                            targets: [
                                { type: 'bond', id: 'bS1O1', atomId: 'O1', newWidth: 3, oldWidth: 1.5, newElectronsO: 4, oldElectronsO: 6, chargeO: '0' }, // Example for resonance
                                { type: 'bond', id: 'bS1O3', atomId: 'O3', newWidth: 1.5, oldWidth: 3, newElectronsO: 6, oldElectronsO: 4, chargeO: '-1' } // Example for resonance
                            ]
                        }
                    }
                ]
            },
            {
                id: 'hoclo',
                name: 'Ácido Hipocloroso',
                formula: 'HOClO',
                formulaHtml: 'HOClO',
                steps: [
                    {
                        explanation: "Paso 1: Calcular electrones de valencia totales. H: 1, O: 6 x 2 = 12, Cl: 7. Total: 1+12+7 = <strong>20 electrones de valencia</strong>.",
                        mathJax: "HOClO",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 15, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'Cl1', symbol: 'Cl', x: 45, y: 20, radius: 4.5, color: '#ccffcc', formal_charge: '' },
                            { id: 'O2', symbol: 'O', x: 60, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                        ],
                        bonds: [],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 0, 'Cl1': 0, 'O2': 0 }
                    },
                    {
                        explanation: "Paso 2: Dibujar el esqueleto (H-O-Cl-O). Se utilizan 6 electrones en los 3 enlaces simples. Restan 14 electrones.",
                        mathJax: "H-O-Cl-O",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 15, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'Cl1', symbol: 'Cl', x: 45, y: 20, radius: 4.5, color: '#ccffcc', formal_charge: '' },
                            { id: 'O2', symbol: 'O', x: 60, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '' },
                        ],
                        bonds: [
                            { id: 'bH1O1', x1: 15, y1: 25, x2: 30, y2: 25, width: 1.5, highlighted: true },
                            { id: 'bO1Cl1', x1: 30, y1: 25, x2: 45, y2: 20, width: 1.5, highlighted: true },
                            { id: 'bCl1O2', x1: 45, y1: 20, x2: 60, y2: 25, width: 1.5, highlighted: true },
                        ],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 0, 'Cl1': 0, 'O2': 0 }
                    },
                    {
                        explanation: "Paso 3: Distribuir los 14 electrones restantes para satisfacer los octetos. Cada oxígeno obtiene 2 o 3 pares libres, y el cloro obtiene 2 pares libres. Arrastra los puntos rojos para ajustarlos.",
                        mathJax: "H-O-Cl-O",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 15, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'O1', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                            { id: 'Cl1', symbol: 'Cl', x: 45, y: 20, radius: 4.5, color: '#ccffcc', formal_charge: '0' },
                            { id: 'O2', symbol: 'O', x: 60, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                        ],
                        bonds: [
                            { id: 'bH1O1', x1: 15, y1: 25, x2: 30, y2: 25, width: 1.5 },
                            { id: 'bO1Cl1', x1: 30, y1: 25, x2: 45, y2: 20, width: 1.5 },
                            { id: 'bCl1O2', x1: 45, y1: 20, x2: 60, y2: 25, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 4, 'Cl1': 4, 'O2': 6 } // O1 gets 2 pairs, Cl gets 2 pairs, O2 gets 3 pairs
                    },
                    {
                        explanation: "Paso 4: Verificar octetos y calcular cargas formales. Todos los átomos cumplen con la regla del octeto (o dúo para H) y las cargas formales son cero. ¡Estructura final!",
                        mathJax: "H-O-Cl-O",
                        atoms: [
                            { id: 'H1', symbol: 'H', x: 15, y: 25, radius: 3, color: '#c2e0ff', formal_charge: '0' },
                            { id: 'O1', symbol: 'O', x: 30, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                            { id: 'Cl1', symbol: 'Cl', x: 45, y: 20, radius: 4.5, color: '#ccffcc', formal_charge: '0' },
                            { id: 'O2', symbol: 'O', x: 60, y: 25, radius: 4, color: '#FFCCCB', formal_charge: '0' },
                        ],
                        bonds: [
                            { id: 'bH1O1', x1: 15, y1: 25, x2: 30, y2: 25, width: 1.5 },
                            { id: 'bO1Cl1', x1: 30, y1: 25, x2: 45, y2: 20, width: 1.5 },
                            { id: 'bCl1O2', x1: 45, y1: 20, x2: 60, y2: 25, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'H1': 0, 'O1': 4, 'Cl1': 4, 'O2': 6 }
                    }
                ]
            },
            {
                id: 'so3_2-',
                name: 'Ion Sulfito',
                formula: 'SO$_3^{2-}$',
                formulaHtml: 'SO₃²⁻',
                steps: [
                    {
                        explanation: "Paso 1: Calcular electrones de valencia totales. S: 6, O: 6 x 3 = 18. Carga iónica: 2- (añadir 2e-). Total: 6+18+2 = <strong>26 electrones de valencia</strong>.",
                        mathJax: "SO_3^{2-}",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '' }, // Central S
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Top
                            { id: 'O2', symbol: 'O', x: 30, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Bottom-left
                            { id: 'O3', symbol: 'O', x: 70, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '' }, // Bottom-right
                        ],
                        bonds: [],
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 0, 'O2': 0, 'O3': 0 }
                    },
                    {
                        explanation: "Paso 2: Dibujar el esqueleto. Azufre central, tres oxígenos alrededor. Se utilizan 6 electrones en los 3 enlaces simples. Restan 20 electrones.",
                        mathJax: "S-(O)_3",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O2', symbol: 'O', x: 30, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '' },
                            { id: 'O3', symbol: 'O', x: 70, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '' },
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5, highlighted: true },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 30, y2: 35, width: 1.5, highlighted: true },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 70, y2: 35, width: 1.5, highlighted: true },
                        ],
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 0, 'O2': 0, 'O3': 0 }
                    },
                    {
                        explanation: "Paso 3: Distribuir los 20 electrones restantes para satisfacer los octetos de los oxígenos. Cada oxígeno recibe 6 electrones (3 pares libres). Quedan 2 electrones.",
                        mathJax: "SO_3^{2-}",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O2', symbol: 'O', x: 30, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O3', symbol: 'O', x: 70, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5 },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 30, y2: 35, width: 1.5 },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 70, y2: 35, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'S1': 0, 'O1': 6, 'O2': 6, 'O3': 6 } // Each O gets 3 lone pairs (6 electrons)
                    },
                    {
                        explanation: "Paso 4: Colocar los 2 electrones restantes en el azufre central como un par libre. Ahora todos los átomos tienen octeto (o dúo).",
                        mathJax: "SO_3^{2-}",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '+1' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O2', symbol: 'O', x: 30, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O3', symbol: 'O', x: 70, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5 },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 30, y2: 35, width: 1.5 },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 70, y2: 35, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'S1': 2, 'O1': 6, 'O2': 6, 'O3': 6 } // S gets 1 lone pair (2 electrons)
                    },
                    {
                        explanation: "Paso 5: Verificar octetos y calcular cargas formales. El S tiene una carga formal de +1, y cada O tiene -1. La carga total es 2-. Se puede considerar resonancia formando un doble enlace para minimizar cargas formales, pero esta es una estructura aceptable.",
                        mathJax: "SO_3^{2-}",
                        atoms: [
                            { id: 'S1', symbol: 'S', x: 50, y: 25, radius: 5, color: '#FFFF99', formal_charge: '+1' },
                            { id: 'O1', symbol: 'O', x: 50, y: 10, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O2', symbol: 'O', x: 30, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                            { id: 'O3', symbol: 'O', x: 70, y: 35, radius: 4, color: '#FFCCCB', formal_charge: '-1' },
                        ],
                        bonds: [
                            { id: 'bS1O1', x1: 50, y1: 25, x2: 50, y2: 10, width: 1.5 },
                            { id: 'bS1O2', x1: 50, y1: 25, x2: 30, y2: 35, width: 1.5 },
                            { id: 'bS1O3', x1: 50, y1: 25, x2: 70, y2: 35, width: 1.5 },
                        ],
                        valence_electrons_per_atom: { 'S1': 2, 'O1': 6, 'O2': 6, 'O3': 6 }
                    }
                ]
            }
        ];

        // --- APLICACIÓN VUE.JS ---
        new Vue({
            el: '#app', // Elemento HTML donde se monta la aplicación Vue
            data: {
                moleculesList: moleculesData.map(mol => ({ id: mol.id, name: mol.name })), // Lista simple para el selector
                selectedMoleculeId: 'h2nnh2', // ID de la molécula seleccionada por defecto
                currentMolecule: null, // Objeto de la molécula actual
                currentStepIndex: 0, // Índice del paso actual
                svgWidth: 100, // Ancho base del SVG (el CSS lo escala)
                svgHeight: 50, // Alto base del SVG (el CSS lo escala)
                isLoading: false, // Estado de carga (para el overlay)
                isDraggingElectron: false, // Bandera para arrastre de electrones
                draggedElectron: null, // Datos del electrón que se está arrastrando
                originalMouseOffset: { x: 0, y: 0 }, // Desplazamiento inicial del ratón al electrón
                isDarkMode: false, // Estado del modo oscuro (por defecto a falso/claro)
                showTutorialModal: false, // Visibilidad del modal de tutorial
                interactiveElectrons: {}, // Almacena las posiciones interactivas de los electrones para cada átomo
            },
            mounted() {
                this.loadMolecule(); // Carga la molécula inicial al iniciar la aplicación
                this.detectDarkModePreference(); // Detecta si el modo oscuro debe estar activo
                
                // Añade listeners globales para arrastrar y soltar electrones
                document.addEventListener('mouseup', this.endDragElectron);
                document.addEventListener('touchend', this.endDragElectron);
                document.addEventListener('mousemove', this.doDragElectron);
                document.addEventListener('touchmove', this.doDragElectron, { passive: false }); // `passive: false` para `preventDefault`

                // Muestra el tutorial la primera vez que se visita la página
                if (!localStorage.getItem('lewisAppTutorialShown')) {
                    this.showTutorialModal = true;
                    localStorage.setItem('lewisAppTutorialShown', 'true');
                }
            },
            computed: {
                // Propiedad computada que devuelve el paso actual de la molécula
                currentStep() {
                    if (!this.currentMolecule) return null;
                    const step = this.currentMolecule.steps[this.currentStepIndex];
                    
                    // Recalcula y actualiza las posiciones de los electrones interactivos para el paso actual
                    if (step && step.atoms) {
                         const newInteractiveElectrons = {};
                         let changed = false; // Bandera para detectar si hubo cambios y evitar re-renders innecesarios
                         step.atoms.forEach(atom => {
                            const numElectrons = step.valence_electrons_per_atom[atom.id] || 0;
                            const currentElectronCount = this.interactiveElectrons[atom.id] ? this.interactiveElectrons[atom.id].length : 0;

                            if (numElectrons !== currentElectronCount) {
                                newInteractiveElectrons[atom.id] = getElectronPositions(numElectrons, 1, atom.radius);
                                changed = true;
                            } else if (this.interactiveElectrons[atom.id]) {
                                // Si el número de electrones no cambia, mantiene las posiciones actuales (las que podrían haber sido arrastradas)
                                newInteractiveElectrons[atom.id] = [...this.interactiveElectrons[atom.id]];
                            } else {
                                newInteractiveElectrons[atom.id] = [];
                            }
                         });

                         // Solo actualiza la propiedad reactiva si realmente hay un cambio
                         if (changed || Object.keys(this.interactiveElectrons).length === 0 || !this.interactiveElectrons[step.atoms[0]?.id]) {
                             this.interactiveElectrons = newInteractiveElectrons;
                         }
                    }
                    return step;
                },
                // Propiedad computada para renderizar el contenido MathJax de la explicación
                renderedMathJax() {
                    if (!this.currentStep || !this.currentStep.mathJax) return '';
                    // Reemplaza etiquetas HTML por comandos MathJax para el formato
                    return `$$\\text{${this.currentStep.explanation.replace(/<\/?ul>|<\/?li>|<strong>|<\/strong>/g, '').replace(/<br>/g, '\\\\')}}$$$$\\quad$$$$${this.currentStep.mathJax}$$`;
                }
            },
            methods: {
                // --- Lógica Central de Moléculas ---
                // Carga la molécula seleccionada del `moleculesData`.
                loadMolecule() {
                    this.isLoading = true; // Activa el overlay de carga
                    this.currentMolecule = moleculesData.find(mol => mol.id === this.selectedMoleculeId);
                    this.currentStepIndex = 0; // Reinicia al primer paso
                    this.interactiveElectrons = {}; // Reinicia el estado de electrones interactivos
                    
                    // Inicializa las posiciones de los electrones para el primer paso de la nueva molécula
                    if (this.currentMolecule && this.currentMolecule.steps[0] && this.currentMolecule.steps[0].atoms) {
                         this.currentMolecule.steps[0].atoms.forEach(atom => {
                            const numElectrons = this.currentMolecule.steps[0].valence_electrons_per_atom[atom.id] || 0;
                            this.$set(this.interactiveElectrons, atom.id, getElectronPositions(numElectrons, 1, atom.radius));
                         });
                    }

                    this.$nextTick(() => { // Espera a que el DOM se actualice
                        // Asegura que MathJax renderice el nuevo contenido
                        if (typeof MathJax !== 'undefined' && MathJax.Hub) {
                             MathJax.Hub.Queue(["Typeset", MathJax.Hub, this.$el]);
                        } else {
                            console.warn("MathJax no cargado o inicializado.");
                        }
                       
                        // Animaciones de entrada para la nueva molécula
                        gsap.from(".lewis-structure-container", { opacity: 0, scale: 0.9, duration: 0.5, ease: "back.out(1.7)" });
                        gsap.from(".explanation", { opacity: 0, y: 20, duration: 0.4, delay: 0.2 });
                        gsap.from(".step-navigation button", { opacity: 0, y: 10, stagger: 0.1, duration: 0.3 });
                        this.isLoading = false; // Desactiva el overlay
                        showToast(`Cargada: ${this.currentMolecule.name}`, 'info');
                    });
                },
                // Navega al siguiente paso.
                nextStep() {
                    if (this.currentStepIndex < this.currentMolecule.steps.length - 1) {
                        this.currentStepIndex++;
                        this.$nextTick(() => {
                            // Actualiza las posiciones de los electrones para el nuevo paso
                            const step = this.currentMolecule.steps[this.currentStepIndex];
                            if (step && step.atoms) {
                                step.atoms.forEach(atom => {
                                    const numElectrons = step.valence_electrons_per_atom[atom.id] || 0;
                                    this.$set(this.interactiveElectrons, atom.id, getElectronPositions(numElectrons, 1, atom.radius));
                                });
                            }
                            if (typeof MathJax !== 'undefined' && MathJax.Hub) {
                                MathJax.Hub.Queue(["Typeset", MathJax.Hub, this.$el]);
                            }
                            gsap.from(".lewis-structure-container", { opacity: 0, x: 50, duration: 0.3, ease: "power2.out" });
                            this.animateStepChanges(); // Anima los cambios del paso
                        });
                    }
                },
                // Navega al paso anterior.
                prevStep() {
                    if (this.currentStepIndex > 0) {
                        this.currentStepIndex--;
                        this.$nextTick(() => {
                            // Actualiza las posiciones de los electrones para el nuevo paso
                            const step = this.currentMolecule.steps[this.currentStepIndex];
                            if (step && step.atoms) {
                                step.atoms.forEach(atom => {
                                    const numElectrons = step.valence_electrons_per_atom[atom.id] || 0;
                                    this.$set(this.interactiveElectrons, atom.id, getElectronPositions(numElectrons, 1, atom.radius));
                                });
                            }
                            if (typeof MathJax !== 'undefined' && MathJax.Hub) {
                                MathJax.Hub.Queue(["Typeset", MathJax.Hub, this.$el]);
                            }
                            gsap.from(".lewis-structure-container", { opacity: 0, x: -50, duration: 0.3, ease: "power2.out" });
                            this.animateStepChanges(); // Anima los cambios del paso
                        });
                    }
                },
                // Reinicia la molécula actual volviéndola a cargar.
                resetCurrentMolecule() {
                    this.loadMolecule();
                    showToast('Estructura reiniciada.', 'info');
                },

                // --- Interactividad de Arrastre de Electrones (Mejorado) ---
                // Obtiene las coordenadas SVG a partir de las coordenadas del cliente (pantalla).
                getSVGPoint(svgElement, clientX, clientY) {
                    try {
                        const CTM = svgElement.getScreenCTM(); // Matriz de transformación de coordenadas
                        const inverseCTM = CTM.inverse(); // Inversa para convertir de pantalla a SVG
                        const svgPoint = svgElement.createSVGPoint();
                        svgPoint.x = clientX;
                        svgPoint.y = clientY;
                        return svgPoint.matrixTransform(inverseCTM);
                    } catch (e) {
                        console.error("Error al obtener el punto SVG:", e);
                        return null;
                    }
                },

                // Inicia el arrastre de un electrón.
                startDragElectron(atomId, electronIndex, event) {
                    this.isDraggingElectron = true;
                    this.draggedElectron = { atomId, electronIndex };

                    const svg = event.currentTarget.closest('svg');
                    if (!svg) {
                        console.error("Elemento SVG no encontrado para arrastre.");
                        return;
                    }

                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;

                    const svgPoint = this.getSVGPoint(svg, clientX, clientY);
                    if (!svgPoint) return;

                    const atom = this.currentStep.atoms.find(a => a.id === atomId);
                    const currentElectronLocal = this.interactiveElectrons[atomId][electronIndex];

                    // Calcula el offset del clic del ratón respecto al centro del electrón
                    this.originalMouseOffset = {
                        x: svgPoint.x - (atom.x + currentElectronLocal.x),
                        y: svgPoint.y - (atom.y + currentElectronLocal.y)
                    };

                    document.body.classList.add('drag-active'); // Añade clase para cambiar el cursor
                    showToast('Arrastrando electrón...', 'info', 1000);
                },
                // Maneja el movimiento del electrón arrastrado.
                doDragElectron(event) {
                    if (!this.isDraggingElectron) return;

                    event.preventDefault(); // Previene el scroll en dispositivos táctiles

                    const svg = document.querySelector('.lewis-structure-container svg');
                    if (!svg) return;

                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;

                    const svgPoint = this.getSVGPoint(svg, clientX, clientY);
                    if (!svgPoint) return;

                    const { atomId, electronIndex } = this.draggedElectron;
                    const atom = this.currentStep.atoms.find(a => a.id === atomId);

                    // Calcula la nueva posición del electrón relativa al centro del átomo
                    const newX = svgPoint.x - atom.x - this.originalMouseOffset.x;
                    const newY = svgPoint.y - atom.y - this.originalMouseOffset.y;

                    // Limita el rango de movimiento del electrón
                    const maxOffset = atom.radius * 2;
                    const clampedX = Math.max(-maxOffset, Math.min(maxOffset, newX));
                    const clampedY = Math.max(-maxOffset, Math.min(maxOffset, newY));

                    // Actualiza la posición del electrón en los datos reactivos de Vue
                    this.$set(this.interactiveElectrons[atomId], electronIndex, { x: clampedX, y: clampedY });
                },
                // Finaliza el arrastre de un electrón.
                endDragElectron() {
                    if (this.isDraggingElectron) {
                        this.isDraggingElectron = false;
                        this.draggedElectron = null;
                        document.body.classList.remove('drag-active');
                        showToast('Electrón soltado. (Lógica de validación de enlace no implementada)', 'info', 2000);
                        // TODO: Aquí se implementaría la lógica para verificar si el electrón fue soltado
                        // cerca de otro átomo para formar un enlace o un par libre, y actualizar la
                        // `currentStep.bonds` o `currentStep.valence_electrons_per_atom` dinámicamente.
                    }
                },

                // --- Animaciones (GSAP) ---
                // Aplica animaciones a los elementos del SVG al cambiar de paso.
                animateStepChanges() {
                    const step = this.currentStep;
                    if (!step) return;

                    // Reinicia la opacidad de los elementos
                    gsap.to(this.$el.querySelectorAll('.bond-line, .electron-dot, .atom-circle, .atom-text, .formal-charge-text'), {
                        opacity: 1,
                        duration: 0.3,
                        ease: "power1.out"
                    });

                    // Animación de resaltado de átomos
                    step.atoms.forEach(atom => {
                        const atomElement = this.$el.querySelector(`[key="atom-${atom.id}"]`);
                        if (atomElement && atom.highlighted) {
                            gsap.fromTo(atomElement.querySelector('.atom-circle'),
                                { scale: 0.8, opacity: 0.5 },
                                { scale: 1, opacity: 1, duration: 0.5, ease: "elastic.out(1, 0.5)" }
                            );
                        }
                    });

                    // Animación de resaltado de enlaces
                    step.bonds.forEach(bond => {
                        const bondElement = this.$el.querySelector(`[key="bond-${bond.id}"]`);
                        if (bondElement && bond.highlighted) {
                            gsap.fromTo(bondElement,
                                { strokeDasharray: bondElement.getTotalLength(), strokeDashoffset: bondElement.getTotalLength() },
                                { strokeDashoffset: 0, duration: 0.7, ease: "power2.out" }
                            );
                        }
                    });

                    // Animaciones personalizadas para pasos específicos (ej. resonancia)
                    if (step.animation && step.animation.type === 'resonance') {
                        gsap.to(this.$el.querySelectorAll('.atom-circle, .atom-text, .electron-dot, .bond-line, .formal-charge-text'), {
                            opacity: 0.7, // Desvanece ligeramente los elementos no involucrados
                            duration: 0.5
                        });

                        step.animation.targets.forEach(target => {
                            if (target.type === 'bond') {
                                const bondElement = this.$el.querySelector(`[key="bond-${target.id}"]`);
                                if (bondElement) {
                                    gsap.to(bondElement, {
                                        strokeWidth: target.newWidth,
                                        duration: 0.7,
                                        ease: "power1.inOut",
                                        opacity: 1
                                    });
                                }
                                // Actualiza el número de electrones y las cargas formales de los átomos afectados
                                const affectedAtom = this.currentStep.atoms.find(a => a.id === target.atomId);
                                if (affectedAtom) {
                                    const atomIndex = this.currentStep.atoms.findIndex(a => a.id === affectedAtom.id);
                                    if (atomIndex !== -1) {
                                        this.$set(this.currentStep.valence_electrons_per_atom, affectedAtom.id, target.newElectronsO);
                                        this.$set(this.currentStep.atoms[atomIndex], 'formal_charge', target.chargeO);
                                        
                                        this.$set(this.interactiveElectrons, affectedAtom.id, getElectronPositions(target.newElectronsO, 1, affectedAtom.radius));
                                    }
                                }
                            }
                        });
                        showToast('¡Animación de Resonancia Activa! Observa los cambios.', 'success', 4000);
                    }
                },

                // --- Alternar Modo Oscuro ---
                // Cambia entre modo claro y oscuro.
                toggleDarkMode() {
                    this.isDarkMode = !this.isDarkMode;
                    document.body.classList.toggle('dark-mode', this.isDarkMode);
                    localStorage.setItem('darkMode', this.isDarkMode); // Guarda la preferencia en el navegador
                    showToast(`Modo ${this.isDarkMode ? 'Oscuro' : 'Claro'} activado.`, 'info');
                },
                // Detecta la preferencia de modo oscuro al cargar la aplicación.
                detectDarkModePreference() {
                    const savedMode = localStorage.getItem('darkMode');
                    if (savedMode === 'true') { // Si hay una preferencia guardada y es 'true', activa el modo oscuro
                        this.isDarkMode = true;
                    } else { // De lo contrario, por defecto es modo claro (false)
                        this.isDarkMode = false;
                    }
                    // Aplica la clase `dark-mode` al `body` según el estado
                    document.body.classList.toggle('dark-mode', this.isDarkMode);
                },

                // --- Descargar Captura de Pantalla ---
                // Genera y descarga una imagen PNG de la estructura de Lewis.
                async downloadScreenshot() {
                    this.isLoading = true;
                    showToast('Preparando descarga...', 'info', 2000);
                    const element = document.getElementById('lewis-structure-area');
                    if (!element) {
                        showToast('Error: Área de estructura no encontrada.', 'error');
                        this.isLoading = false;
                        return;
                    }
                    
                    // Guarda los estilos originales para restaurarlos después de la captura
                    const originalBg = element.style.backgroundColor;
                    const originalBorder = element.style.border;
                    const originalParentBg = element.parentElement.style.backgroundColor;

                    // Establece un fondo blanco temporal para la captura, si no lo tiene.
                    element.style.backgroundColor = 'white';
                    element.style.border = '1px solid #ccc';
                    if (element.parentElement) {
                        element.parentElement.style.backgroundColor = 'white';
                    }

                    await html2canvas(element, {
                        backgroundColor: null, // Deja que el fondo temporal lo maneje
                        scale: 3, // Mayor resolución para la imagen
                        useCORS: true, // Habilita CORS si hay imágenes de orígenes cruzados
                        logging: false, // Deshabilita logs de html2canvas
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png'); // Obtiene la imagen en formato Data URL
                        const link = document.createElement('a'); // Crea un enlace de descarga
                        link.href = imgData;
                        link.download = `estructura_lewis_${this.currentMolecule.id}_paso_${this.currentStepIndex + 1}.png`;
                        document.body.appendChild(link);
                        link.click(); // Simula un clic para descargar
                        document.body.removeChild(link); // Remueve el enlace
                        showToast('Estructura descargada.', 'success');
                    }).catch(error => {
                        console.error('Error al generar la imagen:', error);
                        showToast(`Error al descargar la estructura: ${error.message || ''}`, 'error');
                    }).finally(() => {
                        // Restaura los estilos originales del elemento
                        element.style.backgroundColor = originalBg;
                        element.style.border = originalBorder;
                        if (element.parentElement) {
                            element.parentElement.style.backgroundColor = originalParentBg;
                        }
                        this.isLoading = false;
                    });
                },
                
                // --- Modal de Tutorial/Ayuda ---
                // Abre el modal de tutorial.
                openTutorialModal() {
                    this.showTutorialModal = true;
                },
            },
            // Hook de ciclo de vida: se ejecuta antes de que la instancia Vue sea destruida.
            // Limpia los listeners de eventos para evitar fugas de memoria.
            beforeDestroy() {
                document.removeEventListener('mouseup', this.endDragElectron);
                document.removeEventListener('touchend', this.endDragElectron);
                document.removeEventListener('mousemove', this.doDragElectron);
                document.removeEventListener('touchmove', this.doDragElectron);
            }
        });
        // Lógica JavaScript - Fin
    </script>
</body>
</html>